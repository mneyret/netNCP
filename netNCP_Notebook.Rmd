---
title: "Quantifying the impacts of socio-ecosystem change through expanded ecosystem multifunctionality - netNCP tutorial"
author: "Margot Neyret"
date: "January 2026"
output:
  html_document:
    toc: true
    df_print: paged
  pdf_document:
    toc: true
    number_sections: true
    highlight: tango
    keep_tex: true
  html_notebook:
    toc: true
    code_folding: hide
    df_print: paged
---

# Introduction

This tutorial introduces the **netNCP approach** through a simple, fictional case study.  
It illustrates the main concepts and calculation steps used to quantify how changes in social
and ecological systems affect ecosystem multifunctionality.

The tutorial accompanies the paper by **Neyret et al. (2026)**, *Quantifying the impacts of socio-ecosystem change through expanded ecosystem multifunctionality*, published in *Advances in Ecological Research*.

```{r Setup, message=FALSE}
library(data.table)
library(knitr)
library(ggplot2)
library(cowplot)
library(colorspace)
library(terra)
library(tidyterra)


knitr::opts_chunk$set(
collapse = TRUE,
warning = FALSE,
message = FALSE
)
```

# Case study and preliminary analyses

We consider a fictional landscape composed of:
- **54% intensive pasture**
- **36% woodland**, partly used as extensive silvopasture
- **10% swamp**

Three stakeholder groups are represented:
**farmers**, **foresters**, and **local residents**.

Half of the landscape (shown as a red rectangle below) is privately owned, which may restrict access to some NCP.


```{r Fictional landscape}
landscape <- matrix(
c(rep(c('Pasture','Woodland'), times = c(6,4)),
rep(c('Pasture','Woodland'), times = c(6,4)),
rep(c('Pasture','Swamp','Woodland'), times = c(3,5,2)),
rep(c('Pasture','Swamp','Woodland'), times = c(3,5,2)),
rep(c('Pasture','Woodland'), times = c(6,4)),
rep(c('Pasture','Woodland'), times = c(6,4)),
rep(c('Pasture','Woodland'), times = c(6,4)),
rep(c('Pasture','Woodland'), times = c(6,4)),
rep(c('Pasture','Woodland'), times = c(6,4)),
rep(c('Pasture','Woodland'), times = c(6,4))),
nrow = 10, byrow = TRUE
)


homes <- data.table(
Group = c('Farmers', 'Foresters', 'Locals'),
x = c(2, 4, 9),
y = c(1, 9, 3)
)


ggplot() +
theme_void() +
geom_spatraster(data = rast(landscape), aes(fill = lyr.1)) +
scale_fill_manual(
values = c(Pasture = '#CCFF99', Woodland = 'olivedrab4', Swamp = 'aquamarine3'),
name = 'Land use'
) + geom_rect(aes(xmin = 0, xmax = 10, ymin = 5, ymax = 10), color = 'darkred', fill = NA, linewidth = 3) +
geom_point(data = homes, aes(x, y, shape = Group), size = 3) +
coord_fixed()
```


## NCP indicators and supply

We focus on four nature’s contributions to people (NCP):

- **Climate regulation**, estimated from soil and vegetation carbon sequestration  
- **Livestock production**, measured as annual fodder productivity  
- **Aesthetic value**, derived from flower cover and vegetation diversity  
- **Health risk**, represented by the abundance of disease vectors  

For this example, we assume that:
- Pastures maximize livestock production but score low on aesthetics  
- Woodlands have high aesthetic value and similar sequestration rates as pastures
- Swamps have high disease risk and negative carbon balance due to disturbance

```{r Setup supply data}
Supply_indicators = data.table(LU_type = c('Pasture', 'Woodland', 'Swamp'),
                                Climate_seq_soil = c(0.3, 0.4, -1), # C sequestration rates in soil
                                Climate_seq_veg = c(2, 3, 0),  # C sequestration rates in vegetation
                                Livestock_prod = c(13, 7, 0),  # Fodder productivity
                                Aesthetic_flower = c(20, 40, 50),   # % of flower cover
                                Aesthetic_diversity = c(1, 6, 7),  # # of species present
                                Health_risk = c(0, 0, 20)) # Abundance of disease vectors

kable(Supply_indicators, caption = 'Average indicator values per forest type')
```

### NCP priorities

## Stakeholder priorities

Stakeholders allocated up to **10 points** across the four NCP to express their priorities.
In real applications, these values would be derived from multiple interviews;
here, we use group-level averages.


```{r Setup priority,  echo=FALSE}
Priority_points = data.table(NCP = c('Climate', 'Livestock', 'Aesthetic', 'Health risk'),
                                    Farmers =    c(2, 5, 2, 1),
                                    Foresters =  c(5, 2, 1, 2), 
                                    Locals =     c(1, 1, 2, 6))

kable(Priority_points, caption = 'Priority points per stakeholder group')
```

Priority scores are rescaled between **0 and 1** so that priorities sum to 1 within each group.
This allows direct comparison and weighting of NCP benefits.

```{r Relative priority scores, message = FALSE}

Priority_long = melt(Priority_points[, list(NCP = NCP,
                                           Farmers = Farmers/(sum(Farmers)),
                                           Foresters = Foresters/(sum(Foresters)),
                                           Locals = Locals/(sum(Locals)))],
                         id.vars = 'NCP', variable.name = "Group", value.name = "Priority")

Priority_long[, NCP := factor(NCP, levels = c('Climate','Livestock','Aesthetic', 'Health risk'))]

ggPriority = ggplot(Priority_long, aes(x = NCP, y = Priority, fill = NCP)) +
  geom_col(width = 0.7) +
  scale_fill_brewer(palette = "Oranges", name ='NCP', breaks = c('Climate','Livestock','Aesthetic', 'Health risk')) +
  coord_polar(start = 0.78) + facet_wrap(~Group) +
   scale_y_log10()+
  ylim(0,0.6) + theme_minimal(base_size = 8) + xlab('') + ylab('')+
   theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
    plot.background = element_rect(fill='transparent', color=NA), #transparent plot bg
    strip.text.x = element_text(size = 10),
    legend.position="bottom") + ggtitle('Priority scores')

ggPriority

```


## Supply–benefit/detriment relationships

Ecosystem supply does not translate directly into benefits or detriments.
Instead, each NCP follows a **supply–benefit (or supply–detriment) relationship**,
which may be linear, nonlinear, or threshold-based.

Ideally, these relationships are derived from empirical or semi-quantitative data.
Here, we define generic functional forms to illustrate the method.

All benefits and detriments are scaled between:
- **–1** (maximum detriment),
- **0** (no effect),
- **+1** (maximum benefit).

```{r Setup SB/D relationshps}
# This function takes as input:
#  • the observed supply, 
#  • the name of the single NCP, 
#  • the expected shape of the SB relationship (linear, cubic, with a threshold)
#. • the theoretical minimum and maximum supply of the single NCP
#. • (optional) the threshold

scale01 <- function(x) x / max(abs(x))

SB_relationship <- function(supply, min, max, shape, threshold = NA) {
if (shape == 'linear_benefits') return((supply - min) / (max - min))
if (shape == 'linear_detriments') return(-(supply - min) / (max - min))
if (shape == 'threshold_cubic_benefits')
return(ifelse(supply < threshold, 0,
(supply^3 - min^3) / (max^3 - min^3)))
if (shape == 'detriments_threshold_benefits')
return((supply - threshold) / (max - threshold))
}


```

# Calculation of netNCP

The netNCP calculation follows five steps:

1. Estimate NCP supply and access  
2. Convert supply into benefits or detriments  
3. Adjust supply–benefit relationships under different scenarios  
4. Weight benefits by stakeholder priorities  
5. Aggregate weighted benefits into netNCP scores

### Step 1. NCP supply and access

The first step is to convert the indicator values into (potential) supply estimates. The exact procedure depends on the NCP and indicators. Here, the climate change mitigation is measured as the sum of carbon sequestration rates in soils and trees; livestock production as the fodder productivity (sole indicator); and aesthetic value and health risks as the average of their respective components, after scaling them between 0 and 1.


```{r Indicators to NCP supply}
Supply_NCP = Supply_indicators[, list(LU_type = LU_type,
                                      Climate = scale01(Climate_seq_soil + Climate_seq_veg),
                                      Livestock = scale01(Livestock_prod),
                                      Aesthetic = (scale01(Aesthetic_flower) + scale01(Aesthetic_diversity))/2,
                                      `Health risk` =  scale01(Health_risk))]

Supply_long = melt(Supply_NCP, id.vars = 'LU_type', value.name = 'Supply', variable.name = 'NCP')
Supply_long[, NCP := factor(NCP, levels = c('Climate','Livestock','Aesthetic', 'Health risk'))]

ggSupply = ggplot(Supply_long, aes(x = NCP, y = Supply, fill = NCP)) +
  geom_col(width = 0.7) +
  scale_fill_brewer(palette = "Oranges", name ='NCP', breaks = c('Climate','Livestock','Aesthetic', 'Health risk')) +
  coord_polar(start = 0.78) + facet_wrap(~LU_type) +
   theme_minimal(base_size = 8) + xlab('') + ylab('Supply')+
   theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
    plot.background = element_rect(fill='transparent', color=NA), #transparent plot bg
    strip.text.x = element_text(size = 10),
    legend.position="bottom") + ggtitle('NCP supply scores')
ggSupply

```


### Scenarios

We compare seven scenarios. Each differs from the baseline by **one change only**.

- **Baseline (0):** Current land-use composition (54% pastures, 36% woodland, and 10% swamp).
- **Scenario 1:** Increased woodland, reduced pasture.  
- **Scenario 2:** Restricted access for local residents. Half of the area, including the swamp, is privately owned, which means local residents cannot access the NCP supplied there, except for carbon sequestration, which does not require access. Foresters and farmers can access the whole area.   
- **Scenario 3:** Subsidies increase livestock profitability. Benefits for a given livestock production level increase; the threshold at which the production becomes economically viable decreases.
- **Scenario 4:** Climate regulation becomes a higher priority for all groups.  
- **Scenario 5:** Health risks are ignored.  
- **Scenario 6:** The spatial dimension of supply-benefit relationships is ackowledged: benefits from aesthetics decrease with distance from homes.

#### Baseline situation

```{r Building land use scenarios}
#### Creating a large data table with information on all scenarios
Scenarios <- CJ(
Group = c('Farmers', 'Foresters', 'Locals'),
Scenario = 0:6,
LU_type = c('Pasture', 'Woodland', 'Swamp')
)

## Setting the proportion of each land use in the landscape.
# For most scenarios this is equal to the baseline situation
baseline_prop <- table(landscape) / length(landscape)
Scenarios[, Prop := baseline_prop[LU_type]]
Scenarios[, Access := Prop]
```

#### Adaptation of land use and access for scenarios 1 and 2

```{r Changing land use and access}
# For scenario 1, a large part of the pastures are reforested
Scenarios[Scenario == 1,
          Access := ifelse(LU_type == 'Pasture', 0.2,
                    ifelse(LU_type == 'Woodland', 0.7, 0.1))]


# In scenario 2 locals have no access to the swamp and half the remaining area
Scenarios[Scenario == 2 & Group == 'Locals',
          Access := ifelse(LU_type == 'Swamp', 0, Prop / 2)]

```

We calculate the realised NCP supply, as the total landscape supply (baseline supplied weighted by proportion of each land use) for climate mitigation, restricted to what is accessible for other NCP.
We then sum the overall NCP supply in the whole landscape, across land uses.

```{r Realised NCP supply}
Supply_realised <- merge(Supply_long, Scenarios, by = 'LU_type', allow.cartesian = TRUE)
Supply_realised[, Realised := ifelse(NCP == 'Climate', Supply * Prop, Supply * Access)]
```


### Step 2 and 3. Supply-benefit relationship

#### Baseline situation
The realised supply scores can then be converted into benefits through the supply-benefit relationship. This need to be done independently for each service. We obtain final benefits and detriment scores.

```{r Applying SB/D relationships}
# Here we define the parameters to apply SB/D relationships: determine minimal and maximal theoretical values
  params <- data.table(
  NCP = c('Climate','Livestock','Aesthetic','Health risk'),
  min = c(-1, 0, 0, 0),
  max = c( 1, 1, 1, 1),
  shape = c('detriments_threshold_benefits',
  'threshold_cubic_benefits',
  'linear_benefits',
  'linear_detriments'),
  threshold = c(0, 0.35, NA, NA)
  )


# Apply the function using these parameters.
Supply_realised <- merge(Supply_realised, params, by = 'NCP')
Supply_realised[, Benefit := SB_relationship(Realised, min, max, shape, threshold), by = .I]
```

As an illustration, e plot the overall SB/D relationships (colored ribbons: green is benefits, red is detriments); the lines indicate actual supply values and corresponding benefits/detriments scores

```{r Plot SB/D relationships}

# Create sequential data for plotting purposes
SBdata = data.table(NCP = rep(c('Climate','Livestock','Aesthetic', 'Health risk'), each = 100))
SBdata = merge(SBdata, params, by = 'NCP')
   
SBdata[, Realised := seq(from = unique(min), to =  unique(max), length.out = 100), by = NCP]

SBdata[, Benefit := SB_relationship(Realised, min, max, shape, threshold), by = .I]
   
SBdata[Benefit >= 0, c('ribbon_max', 'ribbon_min') := list(Benefit, 0)]
SBdata[Benefit < 0,  c('ribbon_max', 'ribbon_min') := list(0, Benefit)]

# Start plot
SBplot = ggplot(SBdata, 
           aes(x = Realised, y = Benefit, fill = Benefit>0, ymax = ribbon_max, ymin = ribbon_min)) + facet_wrap(~NCP, , scales = "free") +
              geom_ribbon(alpha = 0.3) +
        scale_fill_manual(values = c('#FDAE61', '#ABDDA4'), labels = c('Detriments', 'Benefits'), name = '')+
              xlab('Supply') + ylab('Benefit') + theme_bw() +
    geom_segment(data = Supply_realised[Scenario == 0,], aes(x = -Inf, xend = Realised, yend = Benefit, y = Benefit), color = 'grey30', inherit.aes = F) +
    geom_segment(data = Supply_realised[Scenario == 0,], aes(x = Realised, xend = Realised, yend = Benefit, y = -Inf),color = 'grey30', inherit.aes = F) +
   theme_classic(base_size = 8) + ylim(-1, 1)+
   theme(
        axis.ticks.x=element_blank(), #remove x axis ticks
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill='transparent', color=NA), #transparent plot bg
        axis.ticks.y=element_blank(),  #remove y axis ticks
        strip.text.x = element_text(size = 10, color = 'black'),
    strip.background = element_rect(colour="NA", fill="NA"),
    legend.position="bottom") + geom_hline(yintercept = 0, size = 0.1)+ geom_vline(xintercept = 0, size = 0.1)+ ggtitle('Supply-benefit relationships')

SBplot
```

#### Adaptation of SB relationship for scenario 3
In scenario 3, subsidies increase the benefits from livestock production.

```{r Change SB/D relationship for livestock in scenario 3}
Supply_realised[Scenario == 3 & NCP == 'Livestock', Benefit := Benefit + 0.2]

```

#### Spatial supply–benefit relationships (Scenario 6).
In Scenario 6, benefits from aesthetic value depend on distance to each stakeholder’s residence.
We apply a simple distance-decay function so that nearby landscape elements contribute more strongly.

This example is purely illustrative.
In applied studies, distance functions and scaling choices should be adapted to the social and ecological context.


```{r Integrate spatial SB/D relationship for aesthetics in scenario 6}
# First we convert the land use map into supply values. Here, supply is equivalent to benefit as we considered a linear SB relationship.
supply_aesthetics = Supply_NCP$Aesthetic
names(supply_aesthetics) = Supply_NCP$LU_type
landscape_supply = matrix(supply_aesthetics[landscape], nrow = 10, byrow = F)
landscape_benefit = rast(landscape_supply,  crs="+proj=longlat +datum=WGS84")

# Then we downweight benefits with increasing distance from people's homes
landscape_r = rast(landscape, crs="+proj=longlat +datum=WGS84") # Adding crs to measure distance; scale not representative!
homes_v = vect(homes, 'points', geom = c('x', 'y'))
crs(homes_v) = crs="+proj=longlat +datum=WGS84"

dist_farm  <- distance(x = landscape_r, y = homes_v[1,])
dist_fore  <- distance(x = landscape_r, y = homes_v[2,])
dist_local <- distance(x = landscape_r, y = homes_v[3,])

dist_farm  <- 1 - (dist_farm / max(values(dist_farm )))
dist_fore  <- 1 - (dist_fore / max(values(dist_fore )))
dist_local <- 1 - (dist_local/ max(values(dist_local)))

landscape_benefit_farm = landscape_benefit * dist_farm
landscape_benefit_fore = landscape_benefit * dist_fore
landscape_benefit_local = landscape_benefit * dist_local

list_plots = c(dist_farm, dist_fore, dist_local,
               landscape_benefit_farm, landscape_benefit_fore, landscape_benefit_local)
names(list_plots) = c('Distance decay (farmers)','Distance decay (foresters)','Distance decay (locals)',
                      'Resulting benefits (farmers)','Resulting benefits (foresters)','Resulting benefits (locals)')
plot(list_plots)

# The supply is the mean of the distance-weighted values across the landscape
Supply_realised[NCP == "Aesthetic" & Scenario == 6 & Group == "Farmers", Benefit := mean(values(landscape_benefit_farm))]
Supply_realised[NCP == "Aesthetic" & Scenario == 6 & Group == "Foresters", Benefit := mean(values(landscape_benefit_fore))]
Supply_realised[NCP == "Aesthetic" & Scenario == 6 & Group == "Locals", Benefit := mean(values(landscape_benefit_local))]
```


### Step 4. Integration of stakeholder priority scores into weighted NCP scores

Now we merge both datasets and calculate weighted benefit scores as benefits x priority.

```{r Integrate priorities}
Weighted <- merge(Supply_realised, Priority_long, by = c('NCP','Group'))
```

#### Changing priorities dor scenarios 4 and 5
For scenario 4, priority for climate regulation increases. For scenario 5, we do not include detrimental NCP, so we change the priority scores of the health risks to 0. In both cases, scores are rescaled to sum to 1.

```{r Change in priorities}
## Scenario 4: all stakeholders prioritise climate regulation more highly
Weighted[Scenario == 4 & NCP == 'Climate', Priority := Priority+0.1]
Weighted[Scenario == 4, Priority := Priority/sum(Priority), by = Group]

## Scenario 5: detriments from disease occurence is disregarded
Weighted[Scenario == 5 & NCP == 'Health risk', Priority := 0]
Weighted[Scenario == 5, Priority := Priority/sum(Priority), by = Group]
```

### Step 5. Calculation of netNCP

Finally we calculate netNCP for each stakeholder group.

```{r Calculate netNCP}
Weighted[, Weighted_score := Benefit * Priority]
Weighted[, NCP := factor(NCP, levels = c('Climate','Livestock','Aesthetic', 'Health risk'))]

Weighted_by_group <- Weighted[, .(Weighted_score = sum(Weighted_score)), by = .(Group, Scenario, NCP)]
netNCP <- Weighted_by_group[, .(netNCP = sum(Weighted_score)), by = .(Group, Scenario)]
  
# Plot baseline situation
ggnetNCP_scenario0 =
  ggplot(Weighted_by_group[Scenario == 0, ], aes(x = Group, y = Weighted_score, fill = NCP)) +
  geom_col(width = 0.8) +
  scale_fill_brewer(palette = "Oranges", name ='NCP', breaks = c('Climate','Livestock','Aesthetic', 'Health risk')) +
  facet_wrap(~Scenario, nrow = 1) +
  theme_minimal(base_size = 8) + xlab('') + ylab('netNCP')+
   theme(axis.text.x=element_text(angle = 45, vjust = 0.5),
         axis.ticks.x=element_blank(),
         plot.background = element_rect(fill='transparent', color=NA), 
    legend.position="none",
    axis.line = element_line(colour = "black", linewidth = 0.5),
    panel.spacing = unit(1.5, "lines"),
    strip.background = element_rect(colour="NA", fill="NA")) +
   geom_errorbar(data = netNCP[Scenario == 0, ], aes(x = Group, y=netNCP,ymin=netNCP,ymax=netNCP), color = 'darkred', size = 0.4 , inherit.aes = FALSE) +
  geom_hline(aes(yintercept = 0), color = 'black', size = 0.3)

# Plot all scenarios
ggnetNCP = 
  ggplot(Weighted_by_group[Scenario != 0, ], aes(x = Group, y = Weighted_score, fill = NCP)) +
  ggtitle('NetNCP across scenarios and stakeholder groups (full red lines)') +
  geom_col(width = 0.8) +
  scale_fill_brewer(palette = "Oranges", name ='NCP', breaks = c('Climate','Livestock','Aesthetic', 'Health risk')) +
  facet_wrap(~Scenario, nrow = 1) +
  theme_minimal(base_size = 8) + xlab('') + ylab('netNCP')+
   theme(axis.text.x=element_text(angle = 45, vjust = 0.5),
         axis.ticks.x=element_blank(), #remove x axis ticks
         plot.background = element_rect(fill='transparent', color=NA), #transparent plot bg
    legend.position="bottom",
    axis.line = element_line(colour = "black", linewidth = 0.5),
    panel.spacing = unit(1.5, "lines"),
    strip.background = element_rect(colour="NA", fill="NA")) +
     geom_errorbar(data = netNCP[Scenario != 0, ], aes(x = Group, y=netNCP,ymin=netNCP,ymax=netNCP), color = 'darkred', size = 0.4 , inherit.aes = FALSE) +
  geom_hline(aes(yintercept = 0), color = 'black', size = 0.3)

ggnetNCP
```

# Conclusion

The netNCP framework integrates NCP supply, access, nonlinear benefit relationships, and stakeholder priorities into a single, transparent metric. This tutorial demonstrates how alternative socio-ecosystem scenarios can be compared while explicitly accounting for trade-offs and stakeholder heterogeneity.

